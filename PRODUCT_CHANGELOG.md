# 项目变更日志（Product Changelog）

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且此项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 2025-11-22

#### 新增
- **角色解锁系统**：
  - 未登录用户只能使用R角色，其他角色需要登录解锁
  - 登录用户默认可以使用1个SSR + 1个SR + 所有R角色
  - 其他SSR和SR角色需要付费解锁
  - 角色锁定状态清晰显示（遮罩、图标、提示文字）
  - 点击锁定角色立即触发解锁流程
  
- **付费解锁功能**：
  - 模拟支付流程（3个步骤：验证支付信息、处理支付请求、确认支付完成）
  - 支付步骤可视化展示，带进度提示
  - 支付成功/失败状态反馈
  - 价格显示：SSR 2.9元，SR 1.9元，R 4.9元
  
- **角色管理优化**：
  - 管理页面与选择页面逻辑统一
  - 显示解锁时间（`owned_at`）
  - 支持点击锁定角色进入付费解锁流程
  - 角色切换菜单只显示已拥有的角色
  - 添加"获得更多角色"入口

#### 改进
- **角色排序**：
  - 可用状态优先（可用的角色在前）
  - 然后按稀有度排序（SSR > SR > R > N）
  - 最后按名称排序
  
- **锁定状态UI**：
  - 半透明遮罩，确保角色信息可见
  - 锁定图标和提示文字清晰显示
  - 不影响用户查看角色详情

#### 变更
- **角色数据**：
  - 删除4个角色：倾听者、沟通导师、路飞、安欣
  - 哆啦A梦稀有度：R → SR
  - 最终角色数量：12个
  
- **价格策略**：
  - SSR: 19.9元 → 2.9元
  - SR: 9.9元 → 1.9元
  - R: 4.9元（保持不变）

#### 技术改进
- 角色可用性计算逻辑，支持未登录和登录两种状态
- 模拟支付流程，为后续接入真实支付系统做准备
- 解锁成功后自动刷新角色列表和重新排序
- 清除所有用户的角色购买记录，恢复到初始状态

### 2025-11-07

#### 新增
- **卡片模式**：
  - 像抽卡游戏一样，输入内容后生成精美的分析卡片
  - 支持文本输入和图片识别（OCR）
  - 精美的抽卡动画，显示"正在识别"、"正在理解"、"正在生成"等动态提示
  - 采用豆包UI风格设计，界面美观现代
  - 卡片模式不会保存到最近对话中，只有点击"保存卡片"才会保存到分析卡片库
- **自由交谈模式**：
  - 预设了7个有趣的AI角色：
    - 原创角色：小智（智慧型）、小暖（情感型）、小机灵（幽默型）
    - 经典IP角色：诸葛亮、孙悟空、哆啦A梦、路飞
  - 每个角色都有独特的性格、语气、说话风格和背景故事
  - 支持多轮对话和上下文记忆（最多30条历史消息）
  - AI回复采用流式输出（SSE），实时显示生成内容
  - 支持Markdown格式显示AI回复
  - 在对话过程中可以随时切换不同的AI角色
  - 选择角色后会自动发送符合角色性格的欢迎消息
  - AI角色会引导用户生成分析卡片
  - 对话会自动保存到最近对话中，支持删除和管理
- **模式选择界面**：
  - 在主页和新建对话界面都可以选择卡片模式或自由交谈模式
  - 未登录用户也可以使用这两种模式
  - 模式选择卡片采用精美的设计，带有图标和简要介绍

#### 改进
- **UI优化**：
  - 卡片模式和自由交谈模式都采用豆包UI风格设计
  - 移除了Header中的"对话意图智能分析"标题文字
  - 优化了用户头像显示，支持自定义头像
  - 优化了侧边栏单条对话时的间距，避免不必要的滚动
- **用户体验**：
  - 删除对话后自动跳转到新建对话页面
  - 优化了流式输出的显示效果，移除了冗余的加载元素
  - 优化了AI消息的显示，移除了角色名称和"你"的文字，只显示头像
  - 用户头像显示在消息右侧，AI头像显示在消息左侧

#### 技术改进
- **后端**：
  - 新增了AI角色管理API（`/api/characters`）
  - 新增了卡片模式API（`/api/card-mode/generate`）
  - 新增了角色对话API（`/api/character-chat/*`）
  - 实现了流式输出（SSE）支持
  - 移除了`context_mode`参数，简化了API调用
  - 优化了数据库会话管理，确保流式输出期间会话保持打开
- **前端**：
  - 新增了`CardModePage`组件
  - 新增了`ChatModePage`组件
  - 新增了`CardDrawAnimation`组件
  - 集成了`ReactMarkdown`用于显示AI回复
  - 实现了SSE流式输出处理
  - 优化了状态管理，支持角色对话的实时更新

### 2025-11-05

#### 新增
- 前端批量OCR可取消：在识别过程中提供“取消识别”按钮，立即终止请求。

#### 改进
- 识别中UI优化：
  - 删除顶部全局进度条，聚焦卡片内进度与操作。
  - 将取消按钮内联到卡片内“识别进度: X / Y”行并美化。
  - 失败态由整图覆盖改为左上角小徽标提示。
- 豆包结构化结果：当无己方消息时，统一左侧展示，避免错位。

#### 修复
- 修复火山OCR分支中 `error_msg` 变量在错误路径下未定义导致的异常。

### 2025-11-01

#### 新增
- **OCR模式选择功能**：
  - 添加极速模式（百度OCR）和性能模式（豆包OCR）两种识别模式
  - 在图片预览界面添加模式选择UI，支持用户自主选择
  - 极速模式：识别速度快，等待时间短，适合快速预览
  - 性能模式：识别效果好，准确度高，等待时间较长

#### 改进
- **简化OCR处理流程**：
  - 移除了流式输出功能，统一使用批量API
  - 简化了处理中的UI，移除复杂的进度显示
  - 简化了文本选择对话框的标题和描述
- **UI优化**：
  - 模式选择卡片设计优化，选中状态更清晰
  - 文本颜色对比度提高，确保清晰可读
  - 标签顺序调整，"已选择"标签显示在角色标签左侧

#### 变更
- 移除了流式API调用相关的代码和状态管理
- 统一了OCR处理逻辑，两种模式使用相同的API接口

### 2025-10-31

#### 新增
- 分析卡片一键导出“长图”体验：导出版式与前端一致，清晰度提升。

#### 改进
- 导出速度优化至 1–2 秒（浏览器预热、禁动画、阻断无关资源、内联样式）。
- 文件名更规范：主题+时间（ASCII 兼容 + UTF-8 filename*）。
- 侧边栏时间显示准确（相对时间函数修复时区与“刚刚/小时前/天前”计算）。
- Toast 提示位置改为屏幕正中央，0.5 秒自动消失。

#### 变更
- 移除 PDF 导出，统一为高质量 PNG 长图。

#### 部署说明
- 后端新增 Playwright 依赖；首次需执行：`python -m playwright install chromium`。

### 新增
- 导出文件名优化（主题+时间格式）
- 时区支持完善（用户本地时间）
- 文件名安全性过滤
- 智能文件名生成逻辑

### 2025-10-29

#### 新增
- 批量OCR接口 `POST /api/chat/ocr/batch`（默认最多4张）。
- OCR结构化输出：按聊天气泡识别发言人（己方/对方），返回 `messages`（含 `speaker_side/speaker_name/text/block_index`）。
- 前端 `MultiImageUploader`：多图上传、批量识别、段落选择；己方靠右、对方靠左的镜像排布与配色。
- 识别等待UI：居中模态、进度条与阶段动画；后端分段计时日志（编码/构包/发送/解析/总计）。

#### 改进
- 识别成功场景不再弹出toast，仅失败提示；等待文案精简。
- 段落选择使用结构化结果；缺省回退到时间戳/用户名/短行合并的本地分段。
- 降低生成开销：批量 `max_tokens=1200`、单图 `max_tokens=1000`；批量/单图请求超时 30s/25s。

#### 修复
- 兼容 `.env` 新增OCR相关字段：`ocr_provider/volc_access_key/volc_secret_key/volc_region`，修复Pydantic校验错误。
- 修复 Dialog 无障碍警告（缺少 Description）。

### 改进
- PDF导出文件名格式优化
- 图片导出文件名格式优化
- 文件名字符安全性处理
- 时区时间显示一致性

### 修复
- 修复导出文件名不够直观的问题
- 修复时区时间不一致的问题
- 修复文件名特殊字符问题

### 技术改进
- 优化文件名生成算法
- 完善时区处理逻辑
- 增强文件名安全性验证

## [1.0.1] - 2024-10-28

### 新增
- 分析结果一键保存为卡片功能
- 对话管理系统（重命名、删除）
- 最近对话列表显示
- 分析卡片管理功能（重命名、删除）
- 智能标题生成（基于意图和时间）
- 删除确认对话框（居中显示）

### 改进
- Toast提示位置优化（移至画面正中）
- 卡片列表查询逻辑优化（支持匿名用户）
- 分析卡片UI美化（渐变背景、悬停效果）
- 按钮布局优化（防止溢出）
- 对话列表高度优化（减少滚动需求）

### 修复
- 修复 `conversations.slice is not a function` 错误
- 修复删除卡片后Toast提示不一致问题
- 修复保存卡片后无法在列表中显示的问题
- 修复DOM嵌套警告（button嵌套问题）
- 修复数组类型安全检查问题

### 技术改进
- 添加数组类型安全检查
- 优化状态管理逻辑
- 改进错误处理机制
- 增强数据完整性验证

## [1.0.0] - 2024-10-24

### 新增
- 基础聊天分析功能
- 图片OCR识别功能
- 分析卡片生成和导出
- 多维度内容分析（意图、情感、语气等）
- 智能回复建议生成
- 现代化UI界面
- PWA支持
- 响应式设计

### 技术栈
- 后端：FastAPI + SQLAlchemy + SQLite
- 前端：React 18 + TypeScript + Vite
- UI：Tailwind CSS + shadcn/ui
- 状态管理：Zustand
- AI服务：豆包API + DeepSeek API





