# 文档变更日志（Documentation Changelog）

所有重要的文档变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且此项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

## 2025-11-27

### 更新
- 新增 `DAILY_SUMMARY_2025_11_27.md`，记录卡片样式重构、Prompt优化和删除逻辑修复
- 更新数据库模型和Schema，支持角色对话卡片不关联普通对话

### 新增
- 游戏风格卡片设计：3D效果、稀有度系统（SSR/SR/R/N）、光效动画
- 卡片生成动画：全屏抽卡动画、进度文字轮播、卡片揭示动画
- AI主动引导生成卡片功能：在适当时机建议用户生成卡片
- Prompt参数化模板系统：通用模板 + 角色特定模板
- 数据库迁移脚本：安全更新analysis_cards表结构

### 重要变更
- 数据库模型调整：
  - `analysis_cards.conversation_id`：`NOT NULL` → `NULLABLE`
  - 允许角色对话和卡片模式生成的卡片不关联普通对话
- 卡片样式重构：
  - 完全重写CardPreview组件，采用游戏风格设计
  - 根据分析结果自动判定稀有度
  - 3D透视和旋转动画
  - 背景光效和闪光效果
- Prompt系统重构：
  - 使用参数化模板减少重复代码
  - 确保每个角色风格符合人设
  - 统一引导逻辑，但表达方式个性化
- AI回复质量提升：
  - `max_tokens`: 1000 → 2000
  - `temperature`: 0.7 → 0.8
  - 回复长度要求：3-5句 → 5-8句
- 删除对话逻辑优化：
  - 删除后立即跳转到正确页面
  - 不会停留在已删除的对话界面
  - 状态完全清除

### 技术改进
- 稀有度判定算法：基于情感强度、意图复杂度、关键点数量
- 3D卡片效果CSS：透视、旋转、光效动画
- Prompt参数化构建：模板 + 角色特定配置
- 双重保障删除逻辑：Sidebar和ChatModePage都会处理跳转

## 2025-11-22

### 更新
- 新增 `DAILY_SUMMARY_2025_11_22.md`，记录角色解锁系统完整实现
- 更新 `PRODUCT_CHANGELOG.md`，添加角色解锁和付费功能

### 新增
- 角色解锁系统：完整的权限控制和付费解锁流程
- 模拟支付流程：3步支付体验（验证、处理、确认）
- 价格配置系统：按稀有度定价（SSR 2.9元，SR 1.9元，R 4.9元）
- 解锁对话框组件：显示角色信息和支付流程
- 用户购买记录重置脚本

### 重要变更
- 权限规则调整：
  - 未登录用户：只能使用R角色
  - 登录用户：1个SSR + 1个SR + 所有R角色
- 角色数据更新：
  - 删除4个角色：倾听者、沟通导师、路飞、安欣
  - 哆啦A梦稀有度：R → SR
- 价格策略调整：
  - SSR: 19.9元 → 2.9元
  - SR: 9.9元 → 1.9元
- 角色管理页面：与角色选择页面逻辑统一，支持解锁流程
- 角色切换菜单：只显示已拥有的角色，添加"获得更多"入口

### 技术改进
- 角色可用性计算逻辑，支持未登录和登录两种状态
- 模拟支付流程UI，3步可视化展示
- 角色排序优化：可用状态优先，然后按稀有度排序
- 锁定状态UI优化：确保角色信息可见

## 2025-11-21

### 更新
- 新增 `DAILY_SUMMARY_2025_11_21.md`，记录AI角色系统全面升级和优化
- 更新 `IMPLEMENTATION_STATUS.md`，添加角色管理功能和新增角色信息

### 新增
- 角色管理功能：用户角色拥有状态管理
- 16个AI角色（聚焦沟通问题解决）
- 游戏化稀有度系统（SSR/SR/R/N）
- 角色管理页面和API
- 空对话过滤机制

### 重要变更
- 修复空对话问题：延迟对话创建，避免无效数据
- 重新设计AI角色系统：所有角色聚焦沟通问题解决
- 角色稀有度调整：经典IP为SR，动漫和影视剧为SSR，原创为R
- 角色选择页面优化：紧凑布局，按稀有度排序
- 角色切换改为对话框形式
- 添加返回按钮和角色管理入口

### 技术改进
- 延迟对话创建逻辑，提升用户体验
- 使用 `sqlalchemy.exists` 过滤空对话
- 创建 `UserCharacter` 模型记录用户角色拥有状态
- 创建角色更新脚本支持角色管理

## 2025-11-07

### 更新
- 新增 `DAILY_SUMMARY_2025_11_07.md`，记录用户认证系统、使用限制系统、用户资料管理等功能的实现。
- 更新根 README：添加用户认证、使用限制、数据隔离等相关功能说明。

### 新增
- 用户注册和登录功能（邮箱/手机验证码）
- 使用次数限制系统（登录用户vs非登录用户）
- 用户资料管理（包括头像上传）
- 登录状态持久化
- 数据隔离（session_token机制）

### 重要变更
- 非登录用户和登录用户的使用次数限制不同
- 登录时自动关联未登录时创建的对话和卡片
- 用户只能看到自己创建的对话和卡片

## 2025-11-06

### 更新
- 新增 `DAILY_SUMMARY_2025_11_06.md`，记录预览页“添加图片”入口统一与交互修复。
- 文档同步前端 UI 变更：移除旧按钮、统一触发同一隐藏文件输入、保留顶部“上传图片”按钮。
 - 根 README/文档索引移除百度OCR相关描述，统一为豆包OCR / 火山引擎OCR；批量OCR参数从 `mode` 调整为 `provider` 示例。

### 重要变更
- 预览网格末尾“添加图片”卡片成为唯一追加入口（与顶部按钮并存）。
- 规避重复 `ref` 的隐藏输入导致的潜在冲突。

## 2025-11-05

### 更新
- 新增 `DAILY_SUMMARY_2025_11_05.md`，记录今日可取消OCR、UI优化与后端修复。
- 更新产品变更日志：加入可取消能力、UI 改进与 bug 修复条目。

### 重要变更
- 识别中仅保留卡片内进度与操作，移除顶部全局进度条文档描述。
- 失败态展示规范调整为小徽标，不再使用整图遮罩。

## 2025-10-31

### 更新
- 同步文档至最新代码改动：
  - 主题切换统一（HTML `dark` + `theme-changing` 瞬时禁用过渡）。
  - Toast 视口调整到正中央并 0.5s 自动消失。
  - 前端样式改为主题令牌；聊天与卡片的暗色可读性更新。
  - 后端导出服务改为 Playwright 渲染 PNG 长图，修复 header 编码（latin-1）问题。
  - 空对话避免策略说明（仅在首条消息时创建）。
- 新增 `DAILY_SUMMARY_2025_10_31.md` 开发记录。

### 新增
- 导出文件名优化（主题+时间格式，ASCII + UTF-8 filename* 兼容）
- 时区支持完善（用户本地时间）
- 文件名安全性过滤
- 智能文件名生成逻辑

### 重要变更
- PDF 导出已下线，统一为图片导出。
- 部署与本地运行新增 Playwright 浏览器安装步骤：`python -m playwright install chromium`。

### 2025-10-29

#### 新增
- 批量OCR接口与结构化输出文档（己方/对方、气泡级分块）。
- 多图上传与段落筛选的交互规范（镜像排布、角色着色、勾选位置）。
- 后端阶段计时日志说明（编码/构包/发送/解析/总计）。

#### 改进
- 识别等待文案精简；成功不再弹toast。
- 批量识别默认限制4张以优化端到端时延。

#### 修复
- 兼容 `.env` OCR扩展字段，避免Pydantic校验错误。





